// numFactoredBinaryTrees.cpp
// leetcode
//
// Created by  Song Ding on 9/11/18.
// Copyright Â© 2018 Song Ding. All rights reserved.
//
#include "common.h"
using namespace std;

namespace numFactoredBinaryTrees {

class Solution {
public:
    int numFactoredBinaryTrees(vector<int>& arr) {
        sort(begin(arr), end(arr));
        int n = arr.size(), M = 1e9+7;
        long res = 0;
        unordered_map<int,int> dp;
        for (int i = 0; i < n; ++i) {
            for (int j = 0; j < i; ++j) {
                if (arr[i]%arr[j] == 0 && dp.count(arr[i]/arr[j])) {
                    dp[arr[i]] += dp[arr[j]] * dp[arr[i]/arr[j]];
                }
            }
            ++dp[arr[i]];
            res = (res + dp[arr[i]]) % M;
        }
        return res;
    }
    int numFactoredBinaryTrees_dfs(vector<int>& A) {
        sort(A.begin(), A.end());
        unordered_set<int> elms(A.begin(), A.end());
        long res = 0;
        unordered_map<int, long> memo;
        for (int i = 0; i < A.size(); ++i) {
            res += asRoot(A[i], A, elms, memo);
        }
        
        return res % mod;
    }

private:
    static const int mod = 1000000007;
    long asRoot(int k, const vector<int>& A, const unordered_set<int>& elms, unordered_map<int, long>& memo) {
        auto it = memo.find(k);
        if (it != memo.end()) {
            return it->second;
        }
        
        long res = 1;
        for (int i = 0; i < A.size() && A[i] < k; ++i) {
            int t = k / A[i];
            if (t <= A[i] && t * A[i] == k && elms.find(t) != elms.end()) {
                long r = asRoot(A[i], A, elms, memo) * asRoot(t, A, elms, memo);
                res += r;
                if (A[i] != t) {
                    res += r;
                }
                res %= mod;
            }
        }
        memo.insert(make_pair(k, res));
        return res;
    }
};

}

/*/
int main() {
    // TODO: prepare parameters here
    vector<vector<int>> A{//{46,144,5040,4488,544,380,4410,34,11,5,3063808,5550,34496,12,540,28,18,13,2,1056,32710656,31,91872,23,26,240,18720,33,49,4,38,37,1457,3,799,557568,32,1400,47,10,20774,1296,9,21,92928,8704,29,2162,22,1883700,49588,1078,36,44,352,546,19,523370496,476,24,6000,42,30,8,16262400,61600,41,24150,1968,7056,7,35,16,87,20,2730,11616,10912,690,150,25,6,14,1689120,43,3128,27,197472,45,15,585,21645,39,40,2205,17,48,136},
        //{2,4},
        {2,4,5,10},
        //{639973773,696116673,665364282,563574,176991927,611346247,824674976,958661048,406551412,359613990,807082433,509083882,552701220,647173658,244627910,373924448,383386670,384124460,735395732,680094876,194569873,993681422,740151209,661773786,338966885,416267747,283763421,49803949,469044288,610739166,644058133,676870579,894138612,116076350,539079115,865475480,514359209,194505174,779290522,337578142,500565189,481743554,958346319,52322248,355304280,878444947,353258818,24965320,474305451,666283709,330546379,178171561,65305940,271830224,969670400,857505569,660596376,598645524,118019132,492076935,418359990,625276851,988899040,951126878,243497637,296628754,856300695,875082143,739153153,882486704,111987372,643024712,207536920,322582323,981174199,948659446,234335302,880958871,918451699,587789153,163414229,253607126,658503851,863442744,412290054,533649006,195678413,964505279,43190685,963063834,771600226,73023318,97352194,92640956,743971241,8080348,502077665,455160495,592094422,858309054,712274673,858291423,938305061,19451352,69282834,945252100,43292724,371769564,851909514,968521207,528157636,205236842,161672384,244426553,898147089,707379514,105202766,946840868,404013867,960950027,780624394,438112975,417250269,927028689,328260333,156117678,748776330,111080453,623412578,785408326,67185518,310987548,445768026,99160997,985643008,882325168,757870502,267298185,916638192,703792049,880389271,329471566,486847491,161612543,971949799,124438844,465084350,151761812,250102973,531788261,951276239,98866880,49977464,693055524,186136365,223194520,526643238,460157346,354859345,233599763,710724758,12714706,205188522,315147147,951835737,411649495,244918806,84328943,286387387,775847292,641788591,843977820,335032915,609757418,760440417,632779033,808511619,253412268,216152956,166837540,27940920,832660508,641932436,920002910,562936678,222036415,469790136,395259210,282189301,904006056,249982359,887896986,333526864,212331505,513380061,714693768,965800499,135812506,835697224,522607126,565521744,400118792,192378208,800524908,1831761,191683376,977775661,206915352,474912280,68332914,716992863,541320937,396004169,975976806,759238856,579547153,336552927,81517799,257197070,113397967,343329845,820374685,394992577,399391816,590862216,856483853,812435493,680234594,342716223,82923098,804156744,978855881,143117801,590162140,894288463,3072017,181053880,363307758,365884339,658021986,495221259,473252930,444807895,262795810,944085760,939934251,557060489,782859925,309552274,137239627,873934328,446436782,94184428,634484505,500253600,35040509,678491208,394247299,535277149,454891746,537549288,833815102,652914334,486171619,287198824,306346724,39050905,163453481,118987882,867810594,410781214,624020741,631087071,585836361,556469955,881585577,346231588,646379276,418702385,558431564,763253968,764308805,515328611,875392363,148764442,741819111,342278498,526537864,561156514,454425467,627868197,647452459,913674989,591460985,800383998,578935207,862999831,967011791,444808368,43418294,64040948,591567495,373548421,643778615,843913586,133731208,48878531,433699419,353927624,753533317,393424820,709767971,576151294,200857089,778639112,456283313,666063722,969612229,986266401,348413763,655847124,540309609,328118729,183375267,454397165,929553047,513177212,624672022,170194632,619891362,428202852,448804250,312578019,143828009,149007761,437511302,683053165,736803735,647180617,856465731,170745203,56434685,176604637,505596581,991047495,251227382,919339389,733253987,14374261,299931267,534770740,592883029,141512658,425682802,323419360,768860943,828475567,16953835,526297200,191301742,19868132,335450941,502609985,987185726,105170022,651467227,277349947,391632379,989480117,194022190,190060976,912551988,285563142,414710659,458423435,711036336,478068836,939806414,873409043,612632044,723239037,50329378,51163204,220182873,228267758,521582430,176816890,546003498,967167537,439502563,754744936,280961560,122080086,173746412,572942702,641733999,512168771,432607143,38042021,822204364,787926683,565867196,984330526,570400493,582214163,520069884,954786329,613027213,728591292,661150106,80411516,556093770,994205339,649606660,191218144,138963960,89885437,137622486,331362759,153492,486335901,597999622,789410770,329572799,617494798,63516937,607764912,154852321,993860955,307450857,223939992,986328795,336416864,124305001,289526008,424181552,312429599,32560773,411863250,349261208,605257929,596430033,108687637,75734224,294016117,639746147,999083694,456201985,733431275,83652446,965429424,79859751,341034275,670564730,628746910,574229831,590956612,388606267,337571803,178382660,138262112,517901516,40013786,679907597,997702909,503556260,115240772,570430701,663701787,510578763,765665817,334833119,419109261,751652605,151372896,943219311,301742647,125703470,100196400,842701903,696079727,995638167,954854366,359736112,303396878,233292903,641445244,376901972,307315483,297205255,560656072,771479981,690950536,454639007,964662910,743626472,723197485,330278876,178930128,675410100,676345465,37300668,536885911,523980652,747444806,747458754,538904026,712474466,703722789,84698037,855642148,161452515,995432916,203585880,538161211,499610998,464046783,790538306,852996203,389329605,667193768,294146320,383550154,362756799,538426913,743097875,798399310,503876213,818971785,91826772,432647343,58668959,845509827,122879625,965264036,787656264,149454478,908486460,113188928,259866936,562373446,60865064,53052431,358298461,412202002,331908377,269183322,481698510,573594448,948063517,77665181,610246737,8076982,381684026,376214980,620147839,916431458,761808692,405898069,804431854,412555761,346976732,176551595,673520351,365759190,519935652,384799658,906981533,561495304,214955608,735763207,104767376,253529626,188295411,531129778,409981651,518055737,468510401,817002043,764036678,929586376,511990030,438635671,5122923,538062820,154806585,733224818,547016812,617565232,710876704,189336145,373209986,12332977,485315536,331406241,614198169,416258315,731716499,226537274,158495020,37497869,210106122,71319148,754466502,597462014,424472035,879421403,150263376,140144938,737094283,83270151,903712238,834144918,158672960,55019335,138207630,956277542,610402473,577846269,89141185,169236874,330413728,198906860,493447938,979702586,223824055,772764307,33439285,669025028,330675490,43944452,493697401,984582420,168446670,541616518,466488410,43971471,57953638,962955651,140443198,920137107,528465304,857214426,546406018,298209841,686194994,410406243,488016876,935741307,910677658,123364662,149719057,740502986,794414613,558891729,463731119,281755995,994389160,863499933,977238612,234257474,142033906,180639005,184039225,4796054,414875929,787925637,484274733,271526729,746668710,225364097,10746129,516567093,139819493,417782036,132616824,68572367,558881577,952130436,792491297,996118282,273498678,55186160,678742688,435826723,713348950,429368153,556278586,670991318,777039741,64974095,608130851,494656540,622804037,495855628,14733588,722087369,936075122,962309028,618972651,469092895,491740436,310932273,760372243,583642091,905581507,140063016,758312838,502483028,251029640,41225898,887880058,911928011,717927865,527418545,347941127,468146519,713616279,755935122,200007606,770385161,554047942,544693156,26634770,867791781,910842723,496411355,418318005,876645049,772200012,720682281,998191795,157712138,395442477,727315020,284472889,646343358,16249608,551207070,326090731,783854176,679418573,788289057,613177970,614656770,508690751,697604646,77205436,409964118,566832607,888969498,467510613,312719418,927655297,431469452,900245642,854694554,152779919,85961117,344380664,217971066,775656687,194592993,508190773,593215184,433922779,968281740,894615802,479633713,882150534,83642479,497477911,806320175,659868023,858917214,384114714,504027647,105396328,841900350,987220500,114061268,552095388,552589912,137991939,629379788,56932957,823247023,343793173,723001469,892938796,861642496,475136080,4435518,929220048,833580853,202533280,286876243,242001746,594174310,235953838,401336766,340618472,435863278,948882164,553904895,755603193,976928396,566691536,891916499,573735580,879743741,325875688,517083934,999079086,116523658,857002786,672714223,319051570,849451300,103942201,626018374,313934732,78794005,497095788,395683745,42371215,175687785,980424123,114177006,703497033,39035858,658532848,594973536,670094492,24400936,412323711,621772277,951884601,341694336,256826429,807026169,41561684,878628987,63264495,290201627,803149729,660571623,736704879,928391589,878438154,916509292,918447003,603399991,690125377,971980402,135190519,472460629,215450989,720136911,289419679,336676157,310241199,581702072,752032709,768875976,478032558,340278960,843379181,437462016,793296515,837171662,405436639,448803468,872192298,854831415,82600326,386606727,576672290,855352413,240782632,186633625,255433319,342077145,956383089,473344141,959591284,856745619,379901391,377867616,777145265,99738702,452951450,642081170,752376099,734284506,713217087,2290233,842014576,311346322,499232534,536131554,927115295,230027650,832495086,216002836,762487110,452614989,515275182,609003,879974198,948061612,47411286,197925182,167602570,4269458,815387051,290975763,419897081,872941364,647273746,539681373,651708240,843989491,961072276,69745969,965725239,223131015,282983874,512292508,904732030,994804024,46750338,546053364,893344270,264221686,524151731,301503175,508132369,202344295,229975802,959357880,99536748,759745399,114187786,575479562,794908060,842010694,871821538,967632108,74511198,606434350,950956162,515208084,452341476,521837549,582528565,928046098,381256570,24228397,116245923,315621558,56343323,578488351,286226015,805749710,731754106,902209265,29612604,628737382,16304817,794393178,655519208,632527674,471506817,228981426,821442505,224671257,870625321,462326203,719965175,23426363,92887393,665302368,721668367,511955244,377300836,590344377,723720321,632035531,189636013,530495752,476532083,402254418,212872914,896408969,922265989,431148480,757816823,200774249,573788994},
        {60588000,36158400,950040,162450288,446000100,1807920,31590000,360,166153680,6,91213584,34186320,915124000,68600,6497400,10,194304,951035904,393822000,23522400,14400,821376000,80,881118000,576000,3660480,106801200,180690300,5100,1573200,36288000,38,197643600,221852925,8820,36000,822294528,13935240,236307456,17409600,443741760,62868,548800000,25271064,34848,344137500,8383500,186,45,100980,722358000,63000000,16442400,1579500,684,12970692,243540,232560,149153400,437400,16215,713460,75524400,118800,1575,106920,10150,13770000,33999966,177811200,64680,2880768,632459520,8675100,498700800,213572700,18657600,22,6993,49,177147000,6480,20,3910368,85201200,1764,120093120,16022160,290822400,6219200,29376000,235290,20979000,5,384,959140,443944800,11303040,952560,47736000,33404280,39936,11864320,144270720,12868224,18289152,87230682,145860,262548,10276500,12,612,179010000,622987200,108475200,1012,60,14880,10924200,2285568,149178000,1573936,195695500,213269760,24975,12000,3706560,168382080,114724,87650640,8019000,8035200,8621844,514500,155,132612480,1676700,627318720,39330,17,926100000,283360,69949440,856575,4092,130,720,958035000,5396820,2668,6606336,169708000,2352240,26,40608000,324576,3220,4945920,187697664,350,3965520,40500,9000,142560,39580800,447051000,19077120,36605250,775,19404,87514000,2673,9720,4942080,56752500,118216665,858,18225,3124800,1530,380160,24554880,2762100,646945200,173210400,22376250,731076192,161,44705100,145981440,18223660,215424,878526000,22883952,92092,7306200,32,2708160,566957475,17305344,119556000,411402240,1292544,454480,2208,27498240,249230520,88058880,2108,527800,455,49846104,801900,252450,7644,129540320,2241675,1330,71089200,2709630,43545600,497250,4972968,826277760,249091200,68827500,60900,271282240,13910400,88609950,46189440,3088800,582912000,4284000,304980000,32736,992,52992,454545000,14064960,72967500,892584000,61678260,3410,49104000,840931520,107805600,200475,35384580,4289408,599079390,777,465696,7956000,540960,3385200,8741250,17748,2528240,2248480,83076840,366282000,15120000,6871956,15586560,992673792,367200,65577600,635796000,150,62524000,7551600,1716660,85932,209986560,6167826,1557192,20702500,157320,14427072,553402080,203290560,3830112,1500,120992256,89280,66943800,8937984,30,32457600,75140,874,34398000,390600,955500,32542560,51068160,6624,545368824,316461600,236670,598067712,97538400,3240000,664801200,6120,477487296,445419000,38318280,148800,7,1055600,9128700,6472800,13176240,535680,7998,345960,1262250,78693120,1364,15,13800,406000,42,23,703872,787939152,24288,37795758,6300000,145704960,124,46920,3142656,31725,92,186300,1470,73500,3495250,196416,639878400,65800,1015680,131176500,37264500,243984000,19227000,917280,9384000,81840,454406400,795217500,147420000,6976800,14651280,116,11960,153740160,799948800,5184000,501686640,1020,773500,145763550,26417664,11446380,13,14817600,406125720,7068600,730667520,3371004,2677752,2692305,70615314,1771,388411200,20175075,14742000,139991040,302400,40131360,21740796,5996025,205615179,469193472,23220,8286300,19706400,2812992,72886425,3072,6557760,551779200,960,74592,185427840,40068864,883872000,85250,3499200,2210,402772500,1274,106260,4392080,953146480,90744192,132699840,4270560,361746000,342720,673536600,2418,234600,967255800,34500,8910,196040,374190336,9790200,694747200,5385600,907200,493426080,804683880,13820544,7999488,4879680,88400,13765500,28,377,172339200,97152,427680,41731200,92610,13950000,564200,2520,74970,11603592,16,18200,201386250,474525,531468,1860,51840,677376,59520,4457400,8912376,6742008,11013975,566280,330832,110707200,172727100,382200,942480,10200,3210480,2033600,11289564,6667920,675347400,79994880,27676800,158100,133722000,66769920,332041248,25,1545600,21450,655966080,11814660,223200,4151040,1016064,35,1607040,924,586333020,174787200,63756,18957120,788900000,351900000,1380,5441800,374,44200,38640,8307684,109707264,2178,7440,6577200,29435,264600000,12960000,2646,891691416,475656192,214033920,431708160,70340256,404736,39104,787059000,3208500,220103100,191268,66960000,18500832,856016640,173901000,1238688,157489920,54782,550946880,242573760,257040,282720,117645000,165369600,13110,434079360,9133344,621000,174037500,126960,6147900,137491200,29559600,700,185220000,317520000,200344320,14036,26601120,3535488,3649940,16240,61659000,430848,779483250,363528000,419764800,729933750,386661600,111481920,35700,6561000,68695200,70,297,83700,990,113076810,461538,787529952,4324,20727,40350150,218700,846720,540,29889000,1016600,277704000,62734080,14856192,210924000,589248000,5760,222393600,30180600,166059400,31021056,98208,21,21168,98208000,13464,1555200,16077600,288,4332042,320550912,204989400,785664,67897440,65472,16228800,70560,80352,8,9520896,71280,4862,44,12545280,657395200,39,64152000,283719996,247443840,924159600,20286000,268065,138983850,9300,5286120,61534200,496601280,875033280,6370,5940,364,29412,261360,1248,477290880,5880,669600,82174400,53568,483000,36,18,29728512,12057760,3046680,44660,368874000,167040,4276800,83462400,11050,638,34300000,27,509110272,437132430,81200,33,6277500,113601600,14850,10789200,157216500,20348928,10701900,365904000,1728,1782960,1255800,38321400,3542,6229872,40864824,514483200,43,1159200,413100,1127100,8019,198251550,47,30950400,2115,46,45900,233280000,125736,200508,5742,222456,442520,245188944,162288000,5589000,76923,2461536,415457280,715936320,179289600,14826240,17150000,13759200,63240,7001280,663000,22776600,221925825,920700,1421000,1715616,30198960,1766100,2480,290,460,1556640,1015,145411200,11350500,824199480,539028000,11865150,882000,19,830297000,159840,7632800,81053840,68250,77873400,123965952,164826900,23040,347200,51323580,30294000,140777000,1023,147556500,273420,13665960,2760,21780,77552640,3245760,341433225,930,12740,441,960498,184988160,219240000,125854344,13986,174960,53978400,2163168,456840000,1513400,179676000,90810720,28569600,4923072,807003000,49758720,47404500,480,42340320,837000000,3,3720,15847920,1400,1715000,251160,198,504708750,8932000,6311250,1458240,96,37235712,911400,255816,142084800,39346560,2384640,38491200,1872000,899640,14586,294624,37,239760,469476000,1015200,531454000,411840,36352800,15367680,273454272,63987840,22416750,24500,171535,683384832,47586240,82800,112266,12746370,429545025,875769840,125468160,74,39412800,45904320,9313920,1589760,24,570240,72912000,107880,1758120,7980,2614640,34,12987000,3124044,728640,21420,4,22855680,21600,99,11,203076720,90132,687447000,5049000,747225,37620,13363200,209265525,171169600,461039040,36946,79197560,35280,108100,22032000,343062720,29141775,906782240,297600,298378080,486129600,979104000,22151360,74576700,1647030,58870,828100,1064,58605120,12182400,860288,41,62107500,9,310495680,71951360,29,105995232,13838,1617000,832431600,328671,510,3826550,689018400,10959300,48,3294060,22720320,132022800,24663600,40,520,6756750,429624000,79497600,11427840,489167910,54734592,10847520,887284800,223948800,735139125,3478200,470235,649152000,86619456,932536800,2976,675,491756100,73780,1142784,5488560,1473780,301693392,8819902,88357500,40392,579600,457113600,2,692841600,77189112,49538412,18086640,104976000,35162400,4320,435,107892000,14,832,257094000,345,323389440,813440,13392000,29760,8391600,599400,1713600,154560,7380480,127429200,198360,8625,459345600,13117650,1309440,85680,41972175,75710880,87339648,55296000,1054,10098,269414640,787644000,34560,253,721353600,28072,5984,148764,84630,25966080,141120,46368,101680,31,82197720,3312400,2980800,18247680,12453120,9108,3050400}
        
    };
    
    vector<int> ans {
        1,
        3,
        7,
        100,
        874417692
    };
    int i = 0;

    // TODO: add return type and paramters.
    clock_t start = clock();
    auto res = numFactoredBinaryTrees::Solution().numFactoredBinaryTrees(A[i]);
    cout << clock() - start << endl;
    cout << res << endl;
    return 0;
}
//*/
